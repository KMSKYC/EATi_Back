name: Deploy EATi to OCI (Systemd)

on:
  push:
    branches:
      - "main"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Backend with Gradle
        run: ./gradlew :backend:clean :backend:bootJar

      - name: Build Consumer with Gradle
        run: ./gradlew :consumer:clean :consumer:bootJar

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.OCI_SSH_KEY }}" > ~/.ssh/eati_key
          chmod 600 ~/.ssh/eati_key

      - name: Copy JARs to OCI server
        run: |
          # Backend JAR 복사
          scp -o StrictHostKeyChecking=no \
              -i ~/.ssh/eati_key \
              -P ${{ secrets.OCI_PORT }} \
              backend/build/libs/*.jar \
              ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }}:/home/opc/eati-deploy/backend.jar

          # Consumer JAR 복사
          scp -o StrictHostKeyChecking=no \
              -i ~/.ssh/eati_key \
              -P ${{ secrets.OCI_PORT }} \
              consumer/build/libs/*.jar \
              ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }}:/home/opc/eati-deploy/consumer.jar

      - name: Deploy and restart services
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          port: ${{ secrets.OCI_PORT }}
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            set -e

            cd /home/opc/eati-deploy

            # Kafka가 실행 중인지 확인
            if ! docker ps | grep -q eati-kafka; then
              echo "Starting Kafka..."
              docker-compose -f docker-compose.kafka.yml up -d
              sleep 15
            fi

            # Backend 배포
            echo "Deploying Backend..."
            sudo systemctl stop eati
            sudo mv /home/opc/eati-deploy/backend.jar /srv/eati/app.jar
            sudo chown eati:eati /srv/eati/app.jar
            sudo chmod 755 /srv/eati/app.jar
            sudo restorecon -v /srv/eati/app.jar || true
            sudo systemctl start eati
            sleep 5

            # Consumer 배포
            echo "Deploying Consumer..."
            sudo systemctl stop eati-consumer
            sudo mv /home/opc/eati-deploy/consumer.jar /srv/eati-consumer/app.jar
            sudo chown eati:eati /srv/eati-consumer/app.jar
            sudo chmod 755 /srv/eati-consumer/app.jar
            sudo restorecon -v /srv/eati-consumer/app.jar || true
            sudo systemctl start eati-consumer
            sleep 5

            # 서비스 상태 확인
            echo "=== Backend Status ==="
            sudo systemctl status eati --no-pager -l

            echo "=== Consumer Status ==="
            sudo systemctl status eati-consumer --no-pager -l

            # 헬스체크
            echo "=== Health Checks ==="
            sleep 10
            curl -f http://localhost:8080/actuator/health || echo "Backend health check failed"
            curl -f http://localhost:8081/actuator/health || echo "Consumer health check failed"

            # NGINX 재시작 (백엔드만)
            sudo systemctl restart nginx
            curl -f http://localhost/ || echo "NGINX proxy check failed"

            # 임시 파일 정리
            rm -f /home/opc/eati-deploy/*.jar
